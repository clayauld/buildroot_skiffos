From dbe953b85803c185cfd011494d079cfaba7e0b29 Mon Sep 17 00:00:00 2001
From: Christian Stewart <christian@paral.in>
Date: Fri, 17 Jul 2020 19:56:44 -0700
Subject: [PATCH] Pass DESTDIR and ROOT_PREFIX to sub-targets in Makefile.in

Fixes bug with leak of host-install to parent system:

https://bugs.busybox.net/show_bug.cgi?id=13081

Signed-off-by: Christian Stewart <christian@paral.in>
---
 MCONFIG.in        | 1 +
 Makefile.in       | 2 +-
 scrub/Makefile.in | 6 +++---
 3 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/MCONFIG.in b/MCONFIG.in
index 6151825..5966065 100644
--- a/MCONFIG.in
+++ b/MCONFIG.in
@@ -35,6 +35,7 @@ pkgconfigdir = $(libdir)/pkgconfig
 pkglibdir = $(libdir)/e2fsprogs
 
 HAVE_UDEV = @have_udev@
+UDEV_RULES_DIR_PREFIX = @root_prefix@
 UDEV_RULES_DIR = @pkg_udev_rules_dir@
 HAVE_CROND = @have_crond@
 CROND_DIR = @crond_dir@
diff --git a/Makefile.in b/Makefile.in
index b951c01..71b9e83 100644
--- a/Makefile.in
+++ b/Makefile.in
@@ -103,7 +103,7 @@ all-progs-recursive install-progs-recursive install-strip-progs-recursive \
 @ALL_CMT@	  if test -d $$subdir ; then \
 @ALL_CMT@	    target=`echo $@|$(SED) 's/-progs-recursive//'`; \
 @ALL_CMT@	    echo making $$target in $$subdir; \
-@ALL_CMT@	    (cd $$subdir && $(MAKE) $$target) || exit 1; \
+@ALL_CMT@	    (cd $$subdir && $(MAKE) $$target DESTDIR=$(DESTDIR)) || exit 1; \
 @ALL_CMT@	  fi ; \
 @ALL_CMT@	done
 
diff --git a/scrub/Makefile.in b/scrub/Makefile.in
index 10c2f43..ab03975 100644
--- a/scrub/Makefile.in
+++ b/scrub/Makefile.in
@@ -86,7 +86,7 @@ e2scrub_all_cron: e2scrub_all_cron.in
 
 installdirs-udev:
 	$(E) "	MKDIR_P $(UDEV_RULES_DIR)"
-	$(Q) $(MKDIR_P) $(DESTDIR)$(UDEV_RULES_DIR)
+	$(Q) $(MKDIR_P) $(DESTDIR)$(UDEV_RULES_DIR_PREFIX)$(UDEV_RULES_DIR)
 
 installdirs-crond:
 	$(E) "	MKDIR_P $(CROND_DIR)"
@@ -108,7 +108,7 @@ installdirs: $(INSTALLDIRS_TGT)
 install-udev: installdirs-udev
 	$(Q) for i in $(UDEV_RULES); do \
 		$(ES) "	INSTALL $(UDEV_RULES_DIR)/$$i"; \
-		$(INSTALL_DATA) $$i $(DESTDIR)$(UDEV_RULES_DIR)/96-$$i; \
+		$(INSTALL_DATA) $$i $(DESTDIR)$(UDEV_RULES_DIR_PREFIX)$(UDEV_RULES_DIR)/96-$$i; \
 	done
 
 install-crond: installdirs-crond
@@ -150,7 +150,7 @@ install: $(PROGS) $(MANPAGES) $(FMANPAGES) installdirs $(INSTALL_TGT)
 
 uninstall-udev:
 	for i in $(UDEV_RULES); do \
-		$(RM) -f $(DESTDIR)$(UDEV_RULES_DIR)/96-$$i; \
+		$(RM) -f $(DESTDIR)$(UDEV_RULES_DIR_PREFIX)$(UDEV_RULES_DIR)/96-$$i; \
 	done
 
 uninstall-crond:
-- 
2.27.0

