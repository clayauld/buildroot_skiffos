From 2fda50f818286aa12fca336967a0505c4cc04412 Mon Sep 17 00:00:00 2001
From: Christian Stewart <christian@paral.in>
Date: Mon, 11 Jul 2022 06:04:33 -0700
Subject: [PATCH] remove dependency on libbsd

Signed-off-by: Christian Stewart <christian@paral.in>
---
 .../include/arch/linux-arm/AndroidConfig.h    |  2 +-
 .../include/arch/linux-arm64/AndroidConfig.h  |  2 +-
 .../include/arch/linux-mips/AndroidConfig.h   |  2 +-
 .../include/arch/linux-mips64/AndroidConfig.h |  2 +-
 .../include/arch/linux-x86/AndroidConfig.h    |  2 +-
 system/core/fs_mgr/fs_mgr_fstab.c             | 40 ++++++++++++++++++-
 system/core/include/cutils/sockets.h          |  2 +-
 7 files changed, 45 insertions(+), 7 deletions(-)

diff --git a/build/core/combo/include/arch/linux-arm/AndroidConfig.h b/build/core/combo/include/arch/linux-arm/AndroidConfig.h
index c06c8bc..b55df9e 100644
--- a/build/core/combo/include/arch/linux-arm/AndroidConfig.h
+++ b/build/core/combo/include/arch/linux-arm/AndroidConfig.h
@@ -273,7 +273,7 @@
 /*
  * Define if the strlcpy() function exists on the system.
  */
-#define HAVE_STRLCPY 1
+#define HAVE_STRLCPY 0
 
 /*
  * Define if the open_memstream() function exists on the system.
diff --git a/build/core/combo/include/arch/linux-arm64/AndroidConfig.h b/build/core/combo/include/arch/linux-arm64/AndroidConfig.h
index bcbda8f..afc1d1c 100644
--- a/build/core/combo/include/arch/linux-arm64/AndroidConfig.h
+++ b/build/core/combo/include/arch/linux-arm64/AndroidConfig.h
@@ -275,7 +275,7 @@
 /*
  * Define if the strlcpy() function exists on the system.
  */
-#define HAVE_STRLCPY 1
+#define HAVE_STRLCPY 0
 
 /*
  * Define if the open_memstream() function exists on the system.
diff --git a/build/core/combo/include/arch/linux-mips/AndroidConfig.h b/build/core/combo/include/arch/linux-mips/AndroidConfig.h
index bb3dc95..a1227fe 100644
--- a/build/core/combo/include/arch/linux-mips/AndroidConfig.h
+++ b/build/core/combo/include/arch/linux-mips/AndroidConfig.h
@@ -290,7 +290,7 @@
 /*
  * Define if the strlcpy() function exists on the system.
  */
-#define HAVE_STRLCPY 1
+#define HAVE_STRLCPY 0
 
 /*
  * Define if the open_memstream() function exists on the system.
diff --git a/build/core/combo/include/arch/linux-mips64/AndroidConfig.h b/build/core/combo/include/arch/linux-mips64/AndroidConfig.h
index 7ded3ce..56e5c6d 100644
--- a/build/core/combo/include/arch/linux-mips64/AndroidConfig.h
+++ b/build/core/combo/include/arch/linux-mips64/AndroidConfig.h
@@ -287,7 +287,7 @@
 /*
  * Define if the strlcpy() function exists on the system.
  */
-#define HAVE_STRLCPY 1
+#define HAVE_STRLCPY 0
 
 /*
  * Define if the open_memstream() function exists on the system.
diff --git a/build/core/combo/include/arch/linux-x86/AndroidConfig.h b/build/core/combo/include/arch/linux-x86/AndroidConfig.h
index 5523e49..f651909 100644
--- a/build/core/combo/include/arch/linux-x86/AndroidConfig.h
+++ b/build/core/combo/include/arch/linux-x86/AndroidConfig.h
@@ -253,7 +253,7 @@
 /*
  * Define if the strlcpy() function exists on the system.
  */
-/* #define HAVE_STRLCPY 1 */
+#define HAVE_STRLCPY 0
 
 /*
  * Define if the open_memstream() function exists on the system.
diff --git a/system/core/fs_mgr/fs_mgr_fstab.c b/system/core/fs_mgr/fs_mgr_fstab.c
index 9ddb464..7c89e74 100644
--- a/system/core/fs_mgr/fs_mgr_fstab.c
+++ b/system/core/fs_mgr/fs_mgr_fstab.c
@@ -17,7 +17,7 @@
 #include <ctype.h>
 #include <stdio.h>
 #include <stdlib.h>
-#include <bsd/string.h>
+#include <string.h>
 #include <sys/mount.h>
 
 #include "fs_mgr_priv.h"
@@ -73,6 +73,44 @@ static struct flag_list fs_mgr_flags[] = {
     { 0,             0 },
 };
 
+size_t                  /* O - Length of string */
+strlcat(char       *dst,        /* O - Destination string */
+              const char *src,      /* I - Source string */
+          size_t     size)      /* I - Size of destination string buffer */
+{
+  size_t    srclen;         /* Length of source string */
+  size_t    dstlen;         /* Length of destination string */
+
+
+ /*
+  * Figure out how much room is left...
+  */
+
+  dstlen = strlen(dst);
+  size   -= dstlen + 1;
+
+  if (!size)
+    return (dstlen);        /* No room, return immediately... */
+
+ /*
+  * Figure out how much room is needed...
+  */
+
+  srclen = strlen(src);
+
+ /*
+  * Copy the appropriate amount...
+  */
+
+  if (srclen > size)
+    srclen = size;
+
+  memcpy(dst + dstlen, src, srclen);
+  dst[dstlen + srclen] = '\0';
+
+  return (dstlen + srclen);
+}
+
 static int parse_flags(char *flags, struct flag_list *fl,
                        struct fs_mgr_flag_values *flag_vals,
                        char *fs_options, int fs_options_len)
diff --git a/system/core/include/cutils/sockets.h b/system/core/include/cutils/sockets.h
index d3270c6..daf43ec 100644
--- a/system/core/include/cutils/sockets.h
+++ b/system/core/include/cutils/sockets.h
@@ -19,7 +19,7 @@
 
 #include <errno.h>
 #include <stdlib.h>
-#include <bsd/string.h>
+#include <string.h>
 #include <stdbool.h>
 
 #ifdef HAVE_WINSOCK
-- 
2.35.1

